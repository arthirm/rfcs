- Start Date: 2018-04-27
- RFC PR:

# Summary

Prebuild addons prior to building the ember app to reduce the application build time

# Motivation

Being able to build only the code that has changed is awesome for developer productivity. Currently, while building an ember application, the addons that are not being developed as part of application are also built during first time. This includes the addons from both node_modules and in-repo. Building addons contribute to majority of the application build time which mainly comes from transpiling the addons. For a large application this might be in the order of few mins. Hence, prebuilding the addons prior to building the application will reduce the app build time significantly.

# Detailed design

Building an addon involves fetching 8 trees (templates, app, vendor, addon, styles, public, test-support, addon-test-support) and compiling them. Trees here map to physical directories.

Not all trees can be prebuilt. Only the addon trees that do not change dynamically between runs can be prebuilt. Hence the trees that are safe to prebuild involve templates, addon, addon-test-support, vendor.

Prebuilding is done in a separate addon `ember-cli-prebuild-addon` by introducing new commands `ember prebuild` (current addon) and `ember prebuild:all` (all addons in current app) which builds the addons and stores it in a prebuilt location.

Under the hood the `ember-cli-prebuild-addon` does, 

-Gets the list of addons (current addon or all addons in current app) to build based on the command
-Gets the list of target groups to prebuild
-Find the location to store the prebuilt addons
-Calls the `prebuild` function which invokes the `treeFor` hook for the requested tree type to compile the trees that needs to be prebuilt
-Merges all trees for the addon and passes it to `broccoli-builder`
-Store the resulting build in the prebuilt location

Then during application build, the `treeFor` hook in `ember-cli` will

-Check if the `isDevelopingAddon` flag is not set
-Check if the requested tree can be prebuilt (any of the default trees that can be prebuilt) use the prebuilt addon if it exists for the same target as the app 
-Finds the md5 checksum of the application target and forms a prebuiltdirectory name by appending checksum of target, addon version, tree name
-Checks if the prebuilt directory for the application target exists
-Returns the prebuilt directory if it exists

## Good Defaults

The application is generally targeted to be run on a set of browsers (e.g, last 2 versions of evergreen browsers). The browser targets dictate the babel plugins that will be used to transpile the code. And the addons will also be transpiled using the targets specified by the app. Hence it is necessary to prebuild the addons for a set of target group and the app can choose to use the prebuilt addon for the target group it needs.

By default, addons will be prebuilt for the default targets specified by ember-cli.

## Onus of prebuilding

Typically, the responsibility of prebuilding the addons should be shared by both the addon and the app.

-The addon can be prebuilt for default targets every time before publishing to npm registry.
-The application should also be able to prebuild all the addons it uses for the target it needs. If the addon has already been prebuilt for the target the application needs it can skip prebuilding it again.
-The application should also be able to blacklist a set of addons that should be opted out of prebuilding while prebuilding all the addons.

## Commands to prebuild

-ember prebuild command to prebuild the current addon 
-ember prebuild:all command prebuilds all the ember addons in the current app. Note: If an addon tree should be prebuilt it should be opted out else the build will break.

Optional parameters include

-`prebuildTarget` - location to fetch the target files for prebuilding. By default, it will be `config/prebuild`.


## Trees that are safe to prebuild

By default, the templates, addon, addon-test-support, vendor trees will be prebuilt. A tree can be safely prebuilt if the `treeFor` hooks for the said trees are not being extended by the addon. If the hook has been extended, it is the responsibility of the addon owner to decide if the tree is safe to prebuilt else opt out of prebuilding for any tree by specifying it in the index.js of the addon.

As a next step, `ember-cli-prebuild-addon` should be able to figure out if the addon has extended `treeFor` hooks and opt out the respective trees from being prebuilt.

## Location to store the prebuilt addons

The addon can specify the location the prebuilt directory can be stored in its index.js. By default, the prebuilt directory will be stored inside the addon whether the addon is prebuilt by the app or the addon itself.

The prebuilt directory will contain the prebuilt addon one for each target. Md5 checksum of each target file is used to generate the directory name.

The checksum will be calculated by sorting the array of browsers to ensure stability.

It will in the format `pre-built/<md5ChecksumOfTargetgroup-addonVersion>/addon`. 
Ember-cli will check if the addon is prebuilt for the same target group by calculating the md5 checksum of app's targets.

## Configuring Target Groups

The addons should be prebuilt for multiple target group. A target group will contain a list of browsers. Prebuilding for multiple target group is necessary because if the application developer decides to use only chrome for building the app then shipping the build code for other browsers to the client is unnecessary and will also impact the build time significantly. Hence having the flexibility to be able to prebuild for different target group is highly important.

Currently `ember prebuild` will look for target group in 

-`<configPath>/prebuild` which can contain a list of target files. The package.json of the addon or app should be able to specify the list of target files that should be used to prebuild. 
-If no target files are present in `config/prebuild`, then it will look for `<configPath>/target.js` 
-If the above ones are not successful, the default ember-cli target will be used.

## Changes in Addon BluePrint

For the addons to be prebuilt by default,

-The addons should have `ember-cli-prebuild-addon` in its package.json
-`ember prebuild` command should be included in  npm `prepack` hook so that the addon will prebuilt before publishing to npm registry.

# Drawbacks

If the application is using the incorrect prebuilt addon, the application build will break

-The latest version of target browser changes continuously hence the prebuilt directory might not necessarily be built for the latest version of the browser. But since current last version will always be a subset of future last versions the prebuilt directory will always be valid. 
-If the addon trees that change dynamically is prebuilt because it was not opted out of prebuilding, it will result in breaking the app build. 
-Since the prebuilt addon is stored inside the addon itself, if the app is prebuilding all the addons which stores the prebuilt directory inside node_modules. So, when the node_modules directory is deleted the addons need to be prebuilt again.

# Open Questions 

-Better way to specify the target groups and prebuild location 
-Better way to identify which prebuilt directory belongs to a target group
-Ensure stability of checksum

# Thanks 

Many thanks to Stefan Penner for helping me drive this forward.